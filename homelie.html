<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homélie du jour</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --background-color: #fdfdfd;
            --text-color: #333333;
            --primary-color: #8C1D18; /* A deep, liturgical red */
            --primary-color-hover: #6a1612;
            --border-color: #e0e0e0;
            --surface-color: #ffffff;
            --font-serif: 'Lora', serif;
            --font-sans: 'Inter', sans-serif;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --border-radius: 8px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem 1rem;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1.5rem;
        }

        h1 {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            font-weight: 500;
            margin: 0;
            color: var(--primary-color);
        }

        .attribution {
            font-size: 0.8rem;
            color: #777;
            margin-top: 0.5rem;
        }

        .attribution a {
            color: #555;
            text-decoration: none;
        }
        .attribution a:hover {
            text-decoration: underline;
        }

        .iframe-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        #aelfFrame {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        main {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #555;
        }

        select {
            font-family: var(--font-sans);
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: #fff;
            font-size: 1rem;
            width: 100%;
            cursor: pointer;
        }
        select:focus {
            outline: 2px solid var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn {
            font-family: var(--font-sans);
            font-size: 1rem;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            grid-column: 1 / -1; /* Span full width in grid */
        }
        .btn-primary:hover {
            background-color: var(--primary-color-hover);
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-left-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .homelie-output-container {
            display: flex;
            flex-direction: column;
        }

        h2 {
            font-family: var(--font-serif);
            margin-top: 0;
            font-weight: 500;
        }

        #homelieOutput {
            width: 100%;
            min-height: 400px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            font-family: var(--font-sans);
            font-size: 1.1rem;
            line-height: 1.7;
            resize: vertical;
            overflow-y: auto;
            cursor: text;
        }
        #homelieOutput:focus {
            outline: 2px solid var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Placeholder simulation for contenteditable div */
        #homelieOutput:empty::before {
            content: attr(data-placeholder);
            color: #999;
            pointer-events: none;
        }

        /* Markdown rendering styles */
        .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4 {
            font-family: var(--font-serif);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 500;
            line-height: 1.3;
        }
        .markdown-body > *:first-child {
            margin-top: 0;
        }
        .markdown-body p {
            margin: 0 0 1em 0;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        .markdown-body strong {
            font-weight: 700;
        }
        .markdown-body em {
            font-style: italic;
        }
        .markdown-body ul, .markdown-body ol {
            padding-left: 2em;
            margin-bottom: 1em;
        }
        .markdown-body blockquote {
            margin: 0 0 1em 0;
            padding-left: 1em;
            border-left: 3px solid var(--border-color);
            color: #555;
            font-style: italic;
        }

        .output-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        #textCounter {
            font-size: 0.85rem;
            color: #666;
            flex-shrink: 0;
        }

        .output-actions {
            display: flex;
            gap: 0.75rem;
        }

        #statusMessage {
            text-align: center;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            display: none; /* Hidden by default */
            font-weight: 500;
        }
        #statusMessage.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        #statusMessage.error {
            background-color: #ffcdd2;
            color: #c62828;
        }

        @media print {
            body {
                padding: 1rem;
                background-color: #fff;
            }
            header, .controls-card, .iframe-container, .output-actions, #statusMessage {
                display: none !important;
            }
            main {
                gap: 0;
            }
            .card {
                border: none;
                box-shadow: none;
                padding: 0;
            }
            #homelieOutput {
                border: none;
                min-height: auto;
                resize: none;
                padding: 0;
                font-size: 12pt;
                color: #000;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Homélie du jour</h1>
        <p class="attribution" id="date-display"></p>
    </header>

    <div class="iframe-container">
        <button id="toggleAelfBtn" class="btn btn-secondary">Afficher les lectures (AELF)</button>
        <div id="aelfFrameContainer" style="display: none; margin-top: 1rem;">
            <iframe id="aelfFrame"
                    style="width:375px; height:667px;"
                    title="Lectures du jour sur aelf.org (vue mobile)">
            </iframe>
        </div>
    </div>

    <main>
        <div class="card controls-card">
            <div class="controls">
                <div class="control-group">
                    <label for="longueur">Longueur souhaitée</label>
                    <select id="longueur">
                        <option value="400">Courte (~400 mots)</option>
                        <option value="600" selected>Moyenne (~600 mots)</option>
                        <option value="800">Longue (~800 mots)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="ton">Ton de l'homélie</label>
                    <select id="ton">
                        <option value="pastoral" selected>Pastoral</option>
                        <option value="catéchétique">Catéchétique</option>
                        <option value="contemplatif">Contemplatif</option>
                    </select>
                </div>

                <button id="generateBtn" class="btn btn-primary">
                    <span>Générer l’homélie</span>
                </button>
            </div>
        </div>

        <div id="statusMessage" role="alert" aria-live="polite"></div>

        <div class="card homelie-output-container" id="homelieResultContainer" style="display:none;">

            <div id="homelieOutput" class="markdown-body" contenteditable="true" data-placeholder="L'homélie générée apparaîtra ici..."></div>
            <div class="output-footer">
                <span id="textCounter">0 mots, 0 caractères</span>
                <div class="output-actions">
                    <button id="regenerateBtn" class="btn btn-secondary">Regénérer</button>
                    <button id="copyBtn" class="btn btn-secondary">Copier le texte</button>
                </div>
            </div>
        </div>

    </main>
</div>

<script>

    // --- GLOBAL VARIABLES ---
    const modelName = 'gpt-5';

    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENT REFERENCES ---
        const generateBtn = document.getElementById('generateBtn');
        const regenerateBtn = document.getElementById('regenerateBtn');
        const copyBtn = document.getElementById('copyBtn');
        const homelieOutput = document.getElementById('homelieOutput');
        const homelieResultContainer = document.getElementById('homelieResultContainer');
        const statusMessage = document.getElementById('statusMessage');
        const textCounter = document.getElementById('textCounter');
        const longueurSelect = document.getElementById('longueur');
        const tonSelect = document.getElementById('ton');
        const aelfFrame = document.getElementById('aelfFrame');
        const toggleAelfBtn = document.getElementById('toggleAelfBtn');
        const aelfFrameContainer = document.getElementById('aelfFrameContainer');

        let lastFetchedHtml = "";

        // --- INITIALIZATION ---
        function initializePage() {
            const todaysDate = getTodaysDateString();
            document.getElementById('date-display').textContent = `${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            aelfFrame.src = `https://www.aelf.org/${todaysDate}/romain/messe`;
            // Set the initial button text with the model name
            setLoadingState(false);
        }

        // --- EVENT LISTENERS ---
        generateBtn.addEventListener('click', handleGeneration);
        regenerateBtn.addEventListener('click', handleGeneration);
        copyBtn.addEventListener('click', copyToClipboard);
        homelieOutput.addEventListener('input', updateTextCounter);

        toggleAelfBtn.addEventListener('click', () => {
            const isHidden = aelfFrameContainer.style.display === 'none';
            if (isHidden) {
                aelfFrameContainer.style.display = 'block';
                toggleAelfBtn.textContent = 'Masquer les lectures (AELF)';
            } else {
                aelfFrameContainer.style.display = 'none';
                toggleAelfBtn.textContent = 'Afficher les lectures (AELF)';
            }
        });

        // --- CORE FUNCTIONS ---

        async function handleGeneration() {
            setLoadingState(true);
            showStatus("Initialisation...");

            homelieOutput.innerHTML = '';
            homelieResultContainer.style.display = 'flex';
            homelieResultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

            try {
                if (!lastFetchedHtml) {
                    showStatus("Chargement des textes liturgiques depuis aelf.org...");
                    const sourceHtml = await fetchAelfHtml();
                    lastFetchedHtml = sourceHtml;
                }

                showStatus("Génération en cours 🙏...");

                const length = longueurSelect.value;
                const tone = tonSelect.value;
                const systemPrompt = `Tu es un prêtre catholique expérimenté qui rédige des homélies pour la messe. Rédige l'homélie uniquement en français. Ton style doit être pastoral, profond, et accessible. Ancre ton propos solidement dans les textes liturgiques que tu extrairas du code HTML fourni. L'homélie doit comprendre une très brève prière d'ouverture, un corps de 3 à 5 paragraphes, et se terminer par une simple phrase de bénédiction. Structure ta réponse en utilisant le format Markdown (titres avec #, gras avec **, italique avec *) pour une meilleure lisibilité. Évite tout langage politique ou polémique. Concentre-toi sur la foi, l'espérance et la charité, en reliant les Écritures à la vie concrète des fidèles.`;
                const userInstructions = `Voici le code source HTML complet de la page des lectures du jour de aelf.org. Ta première tâche est d'extraire de ce code les textes liturgiques pertinents (première lecture, psaume, évangile, etc.). Ignore tout le reste (menus, scripts, styles, etc.).\n\n---DEBUT DU CODE HTML---\n${lastFetchedHtml}\n---FIN DU CODE HTML---\n\nUne fois les textes extraits, utilise-les pour rédiger une homélie d'un ton "${tone}" et d'une longueur approximative de ${length} mots. Ne fournis que le texte final de l'homélie, sans aucun commentaire ou en-tête technique.`;


                const stream = await puter.ai.chat(
                    [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userInstructions }
                    ],
                    {
                        model: modelName,
                        stream: true
                    }
                );

                let fullResponseMarkdown = "";
                for await (const part of stream) {
                    if (part?.text) {
                        fullResponseMarkdown += part.text;
                        // Continuously parse markdown to render the formatted text as it streams
                        homelieOutput.innerHTML = marked.parse(fullResponseMarkdown);
                        updateTextCounter();
                    }
                }

                showStatus("Homélie générée avec succès.", false);

            } catch (error) {
                console.error("Erreur lors du processus de génération:", error);
                showStatus(`Erreur : ${error.message}`, true);
            } finally {
                setLoadingState(false);
            }
        }

        function getTodaysDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        async function fetchAelfHtml() {
            const date = getTodaysDateString();
            const aelfUrl = `https://www.aelf.org/${date}/romain/messe`;

            let response;
            try {
                // Using puter.net.fetch for cross-origin requests
                response = await puter.net.fetch(aelfUrl);
            } catch (networkError) {
                throw new Error("Problème de réseau en contactant le service puter.com. Vérifiez votre connexion.");
            }

            if (!response.ok) {
                throw new Error(`Le site aelf.org n'a pas pu être atteint pour la date ${date} (statut: ${response.status}).`);
            }

            const fullHtml = await response.text();

            if (!fullHtml || fullHtml.length < 500) {
                throw new Error("Le code source HTML récupéré de aelf.org est vide ou trop court.");
            }

            return fullHtml;
        }

        // --- UI HELPER FUNCTIONS ---

        function setLoadingState(isLoading) {
            const buttons = [generateBtn, regenerateBtn];
            buttons.forEach(btn => btn.disabled = isLoading);

            if (isLoading) {
                generateBtn.innerHTML = `<span></span><div class="loader"></div>`;
            } else {
                generateBtn.innerHTML = `<span>Générer l’homélie (${modelName})</span>`;
            }
        }
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'error' : 'success';
            statusMessage.style.display = 'block';
        }

        function updateTextCounter() {
            // Use textContent to get the plain text for accurate counting
            const text = homelieOutput.textContent || "";
            const charCount = text.length;
            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
            textCounter.textContent = `${wordCount} mots, ${charCount} caractères`;
        }

        function copyToClipboard() {
            if (!navigator.clipboard) {
                showStatus("La copie dans le presse-papiers n'est pas prise en charge par votre navigateur.", true);
                return;
            }
            // Copy the plain text content, not the HTML markup
            navigator.clipboard.writeText(homelieOutput.textContent).then(() => {
                copyBtn.textContent = 'Copié !';
                setTimeout(() => {
                    copyBtn.textContent = 'Copier le texte';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showStatus("La copie a échoué. Le presse-papiers n'est peut-être pas accessible.", true);
            });
        }

        // Run initialization when the DOM is ready
        initializePage();
    });
</script>
</body>
</html>