<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>LUMINAIRA</title>
    <meta name="theme-color" content="#0f0f23">
    <meta name="color-scheme" content="dark">


    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --bg-dark: #0f0f23;
            --bg-card: #1a1a2e;
            --bg-input: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border: #374151;
            --code-bg: #0d0d1f;
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --glow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html {
            height: -webkit-fill-available;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #16213e 100%);
            background-attachment: fixed; /* <-- THE FIX IS HERE */
            color: var(--text-primary);
            min-height: 100vh;
            /* Use -webkit-fill-available for Safari compatibility */
            min-height: -webkit-fill-available;
            overflow-x: hidden;
        }

        /* --- Background Animation --- */
        .background-animation { 
            position: fixed; /* Reverted back to fixed as intended */
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: -1; 
        }
        .floating-orb { position: absolute; border-radius: 50%; background: linear-gradient(45deg, var(--primary), var(--primary-light)); opacity: 0.1; animation: float 6s ease-in-out infinite; }
        .floating-orb:nth-child(1) { width: 200px; height: 200px; top: 10%; left: 10%; animation-delay: 0s; }
        .floating-orb:nth-child(2) { width: 150px; height: 150px; top: 60%; right: 10%; animation-delay: 2s; }
        .floating-orb:nth-child(3) { width: 100px; height: 100px; bottom: 10%; left: 50%; animation-delay: 4s; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-20px) rotate(180deg); } }
        
        /* --- Layout & Main Components --- */
        .container { max-width: 800px; margin: 0 auto; padding: 1rem; position: relative; z-index: 1; display: flex; flex-direction: column; height: 100vh; height: -webkit-fill-available; }
        .header { text-align: center; margin-bottom: 1rem; flex-shrink: 0; }
        .title { font-size: clamp(2rem, 5vw, 2.5rem); font-weight: 800; background: linear-gradient(135deg, var(--primary-light), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.25rem; animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { filter: drop-shadow(0 0 5px rgba(99, 102, 241, 0.3)); } to { filter: drop-shadow(0 0 15px rgba(99, 102, 241, 0.6)); } }
        .subtitle { font-size: 1rem; color: var(--text-secondary); font-weight: 300; }
        .model-info { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .chat-container { display: flex; flex-direction: column; flex-grow: 1; background: var(--bg-card); border-radius: 24px; border: 1px solid var(--border); box-shadow: var(--shadow); backdrop-filter: blur(10px); overflow: hidden; position: relative; }
        .chat-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--primary), transparent); }
        
        /* --- Chat Output Area --- */
        .output-area { flex-grow: 1; padding: 1.5rem; overflow-y: auto; border-bottom: 1px solid var(--border); background: linear-gradient(to bottom, transparent, rgba(99, 102, 241, 0.02)); scroll-behavior: smooth; }
        .output-area::-webkit-scrollbar { width: 8px; }
        .output-area::-webkit-scrollbar-track { background: var(--bg-input); }
        .output-area::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        
        /* --- Messages --- */
        .message { display: flex; gap: 1rem; margin-bottom: 1.5rem; max-width: 95%; animation: messageSlide 0.5s ease-out; }
        @keyframes messageSlide { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
        .message-content { flex: 1; padding: 0.75rem 1rem; border-radius: 16px; word-wrap: break-word; line-height: 1.6; }
        .user-message { margin-left: auto; flex-direction: row-reverse; }
        .user-message .message-content { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3); }
        .user-message .message-avatar { background: var(--primary-light); }
        .ai-message { margin-right: auto; }
        .ai-message .message-content { background: var(--bg-input); border: 1px solid var(--border); }
        .ai-message .message-avatar { background: var(--border); }
        .streaming-indicator { display: inline-block; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
        
        /* --- Input Section --- */
        .input-section { padding: 1rem; background: linear-gradient(to top, rgba(26, 26, 46, 0.8), transparent); flex-shrink: 0; }
        .input-container { display: flex; gap: 0.75rem; align-items: flex-end; }
        .prompt-input { flex: 1; background: var(--bg-input); border: 2px solid var(--border); border-radius: 16px; padding: 0.75rem 1rem; color: var(--text-primary); font-size: 1rem; font-family: inherit; resize: none; overflow-y: hidden; transition: all 0.3s ease; line-height: 1.5; max-height: 120px;}
        .prompt-input:focus { outline: none; border-color: var(--primary); box-shadow: var(--glow); transform: translateY(-2px); }
        .prompt-input::placeholder { color: var(--text-secondary); }
        .send-button { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3); flex-shrink: 0; }
        .send-button:hover:not(:disabled) { transform: translateY(-2px) scale(1.05); box-shadow: 0 12px 40px rgba(99, 102, 241, 0.4); }
        .send-button:active:not(:disabled) { transform: translateY(0) scale(1); }
        .send-button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* --- CORRECTED SPINNER STYLES --- */
        .send-button .send-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .send-button .loader {
            display: none;
        }
        .send-button.loading .send-icon {
            display: none;
        }
        .send-button.loading .loader {
            display: block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- Status Bar --- */
        .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; background: var(--bg-input); border-top: 1px solid var(--border); font-size: 0.8rem; color: var(--text-secondary); flex-shrink: 0; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; animation: pulse 2s ease-in-out infinite; }
        .status-dot.error { background: #ef4444; }
        .status-dot.processing { background: #f59e0b; }
        
        /* --- Empty State & Prompt Suggestions --- */
        .empty-state { text-align: center; padding: 2rem 1rem; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .empty-state-icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.8; }
        .empty-state h2 { color: var(--text-primary); font-size: 1.25rem; margin-bottom: 0.5rem; }
        .prompt-suggestions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1.5rem; justify-content: center; }
        .suggestion-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 0.875rem; }
        .suggestion-btn:hover { background: var(--primary); color: white; border-color: var(--primary-light); transform: translateY(-2px); }

        /* --- Markdown and Code Block Styles --- */
        .message-content pre { background-color: var(--code-bg); border: 1px solid var(--border); border-radius: 12px; margin: 1rem 0; position: relative; font-size: 0.9rem; }
        .code-block-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; background-color: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); font-size: 0.875rem; color: var(--text-secondary); border-top-left-radius: 11px; border-top-right-radius: 11px; }
        .copy-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); padding: 0.25rem 0.5rem; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-family: inherit; }
        .copy-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .copy-btn.copied { background-color: #22c55e; color: white; border-color: #22c55e; }
        .message-content code { font-family: 'Fira Code', 'Courier New', monospace; }
        .message-content pre code { display: block; padding: 1rem; overflow-x: auto; color: #d1d5db; }
        .message-content :not(pre) > code { background-color: var(--bg-input); padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 6px; }
        .message-content ul, .message-content ol { padding-left: 1.5rem; margin: 1rem 0; }
        .message-content li { margin-bottom: 0.5rem; }
        .message-content strong { font-weight: 700; }
        .message-content em { font-style: italic; }
        .message-content p { margin: 1rem 0; }
        .message-content p:first-child { margin-top: 0; }
        .message-content p:last-child { margin-bottom: 0; }


        /* --- Desktop-Specific Adjustments --- */
        @media (min-width: 769px) {
            .container {
                padding: 2rem;
            }
            .header {
                margin-bottom: 2rem;
            }
            .title {
                font-size: 3.5rem;
            }
            .subtitle {
                font-size: 1.1rem;
            }
            .output-area {
                padding: 2rem;
            }
            .message-avatar {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            .message-content {
                padding: 1rem 1.5rem;
            }
            .input-section {
                padding: 1.5rem;
            }
            .input-container {
                gap: 1rem;
            }
            .prompt-input {
                padding: 1rem 1.5rem;
                max-height: 200px;
            }
            .send-button {
                width: 52px;
                height: 52px;
            }
            .status-bar {
                padding: 0.75rem 1.5rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="floating-orb"></div>
        <div class="floating-orb"></div>
        <div class="floating-orb"></div>
    </div>

    <div class="container">
        <header class="header">
            <h1 class="title">LUMINAIRA</h1>
            <p class="subtitle"></p>
            <p class="model-info" id="modelInfo"></p>
        </header>

        <main class="chat-container">
            <div class="output-area" id="outputArea" aria-live="polite">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">âœ¨</div>
                    <h2>Start a new conversation</h2>
                    <p>What can I help you with today?</p>
                    <div class="prompt-suggestions" id="promptSuggestions">
                        </div>
                </div>
            </div>

            <section class="input-section">
                <div class="input-container">
                    <textarea
                        class="prompt-input"
                        id="promptInput"
                        placeholder="Message LUMINAIRA..."
                        rows="1"
                    ></textarea>
                    <button class="send-button" id="sendButton" aria-label="Send Message">
                        <span class="send-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                            <span class="loader"></span>
                    </button>
                </div>
            </section>

             <footer class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Ready</span>
                </div>
                <div id="tokenCount">0 tokens</div>
            </footer>
        </main>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            new LLMChat();
        });

        class LLMChat {
            // Private fields for better encapsulation
            #config = {
                apiUrl: 'https://5cb6-174-88-255-123.ngrok-free.app/v1/chat/completions',
                model: 'gemma-2-2b-it',
                bearerToken: 'lm-studio',
  systemPrompt: 'You are an expert, highly capable, and dependable AI assistant. Your core purpose is to provide direct, accurate, and comprehensive responses to user queries.Prioritize clarity and conciseness in all interactions. Do not include extraneous conversational elements such as disclaimers, warnings, self-referential statements about being an AI, or apologies, unless explicitly required by the user\'s request. Maintain a strictly neutral, objective, and respectful tone.If a query falls outside your knowledge domain, clearly state that you do not have the information and, where appropriate, guide the user toward potential avenues for finding the answer.'            };

            #elements = {};
            #isStreaming = false;
            #messages = [];
            #wakeLock = null;

            constructor() {
                this.#initializeElements();
                this.#bindEvents();
                this.#updateStatus('Ready', 'success');
                // Set the model information text
                this.#elements.modelInfo.textContent = `${this.#config.model} running on a potato`; 
            }

            #initializeElements() {
                this.#elements = {
                    outputArea: document.getElementById('outputArea'),
                    promptInput: document.getElementById('promptInput'),
                    sendButton: document.getElementById('sendButton'),
                    statusDot: document.getElementById('statusDot'),
                    statusText: document.getElementById('statusText'),
                    tokenCount: document.getElementById('tokenCount'),
                    emptyState: document.getElementById('emptyState'),
                    promptSuggestions: document.getElementById('promptSuggestions'),
                    modelInfo: document.getElementById('modelInfo')
                };
            }

            #bindEvents() {
                this.#elements.sendButton.addEventListener('click', () => this.#sendMessage());
                this.#elements.promptInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.#sendMessage();
                    }
                });
                this.#elements.promptInput.addEventListener('input', () => {
                    this.#updateTokenCount();
                    this.#autoResizeTextarea();
                });

                // Handle visibility change for Wake Lock
                document.addEventListener('visibilitychange', () => this.#handleVisibilityChange());
                
                // Use event delegation for dynamically added elements
                this.#elements.outputArea.addEventListener('click', (e) => {
                    if (e.target.matches('.copy-btn')) {
                        this.#handleCopyClick(e.target);
                    }
                });

                if (this.#elements.promptSuggestions) {
                    this.#elements.promptSuggestions.addEventListener('click', (e) => {
                        if(e.target.matches('.suggestion-btn')) {
                            this.#elements.promptInput.value = e.target.textContent;
                            this.#elements.promptInput.focus();
                            this.#updateTokenCount();
                            this.#autoResizeTextarea();
                        }
                    });
                }
            }

            #autoResizeTextarea() {
                this.#elements.promptInput.style.height = 'auto';
                this.#elements.promptInput.style.height = `${this.#elements.promptInput.scrollHeight}px`;
            }

            #updateTokenCount() {
                const text = this.#elements.promptInput.value;
                const estimatedTokens = Math.ceil(text.length / 4);
                this.#elements.tokenCount.textContent = `${estimatedTokens} tokens`;
            }

            #updateStatus(text, type = 'success') {
                this.#elements.statusText.textContent = text;
                this.#elements.statusDot.className = `status-dot ${type}`;
            }

            #addMessage(content, role) {
                if (this.#elements.emptyState) {
                    this.#elements.emptyState.remove();
                    this.#elements.emptyState = null;
                }

                const messageWrapper = document.createElement('div');
                messageWrapper.className = `message ${role}-message`;

                const avatar = role === 'user' ? 'ðŸ‘¤' : 'âœ¨';
                const renderedContent = this.#renderMarkdown(content);

                messageWrapper.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">${renderedContent}</div>
                `;

                this.#elements.outputArea.appendChild(messageWrapper);
                this.#elements.outputArea.scrollTop = this.#elements.outputArea.scrollHeight;
                return messageWrapper;
            }
            
            #updateStreamingMessage(messageWrapper, content, isComplete = false) {
                let renderedContent = this.#renderMarkdown(content);
                if (!isComplete && content.length > 0) {
                    renderedContent += '<span class="streaming-indicator"></span>';
                }
                
                messageWrapper.querySelector('.message-content').innerHTML = renderedContent;
                this.#elements.outputArea.scrollTop = this.#elements.outputArea.scrollHeight;
            }

            async #sendMessage() {
                const prompt = this.#elements.promptInput.value.trim();
                if (!prompt || this.#isStreaming) return;

                this.#toggleLoading(true);
                this.#updateStatus('Sending...', 'processing');

                await this.#requestWakeLock();

                this.#addMessage(prompt, 'user');
                this.#messages.push({ role: 'user', content: prompt });

                this.#elements.promptInput.value = '';
                this.#autoResizeTextarea();
                this.#updateTokenCount();

                try {
                    const response = await fetch(this.#config.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.#config.bearerToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: this.#config.model,
                            messages: [
                                { role: 'system', content: this.#config.systemPrompt },
                                ...this.#messages
                            ],
                            temperature: 0.7,
                            stream: true
                        })
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    this.#updateStatus('Receiving...', 'processing');
                    const aiMessageWrapper = this.#addMessage('', 'ai');
                    let fullResponse = '';

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data.trim() === '[DONE]') continue;
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    const delta = parsed.choices?.[0]?.delta?.content;
                                    if (delta) {
                                        fullResponse += delta;
                                        this.#updateStreamingMessage(aiMessageWrapper, fullResponse);
                                    }
                                } catch (e) { /* Skip invalid JSON chunks */ }
                            }
                        }
                    }

                    this.#updateStreamingMessage(aiMessageWrapper, fullResponse, true);
                    this.#messages.push({ role: 'assistant', content: fullResponse });
                    this.#updateStatus('Ready', 'success');

                } catch (error) {
                    console.error('Error:', error);
                    this.#addMessage(`**Error:**\n\`\`\`\n${error.message}\n\`\`\``, 'ai');
                    this.#updateStatus('Error', 'error');
                } finally {
                    this.#toggleLoading(false);
                    await this.#releaseWakeLock();
                }
            }
            
            #toggleLoading(isLoading) {
                this.#isStreaming = isLoading;
                this.#elements.sendButton.disabled = isLoading;
                this.#elements.promptInput.disabled = isLoading;
                this.#elements.sendButton.classList.toggle('loading', isLoading);
            }
            
            #renderMarkdown(text) {
                let html = text
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .trim();

                // Code blocks (```lang\ncode\n```)
                html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                    const language = lang || 'plaintext';
                    const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return `
                        <pre><div class="code-block-header"><span>${language}</span><button class="copy-btn">Copy</button></div><code class="language-${language}">${escapedCode.trim()}</code></pre>
                    `;
                });

                // Process remaining text line by line for lists and paragraphs
                const lines = html.split('\n');
                let inList = null; // 'ul' or 'ol'
                let processedHtml = '';

                for(let i = 0; i < lines.length; i++) {
                    let line = lines[i];

                    if (line.startsWith('<pre>')) {
                        // If we are in a code block, just append it and continue
                        const preEnd = html.indexOf('</pre>', html.indexOf(line));
                        const block = html.substring(html.indexOf(line), preEnd + 6);
                        processedHtml += block;
                        // Skip lines that are part of the code block
                        const lineCount = block.split('\n').length;
                        i += lineCount - 1;
                        inList = null; // Exit list state
                        continue;
                    }

                    // Bold and Italics
                    line = line.replace(/\*\*([^\*]+)\*\*|__([^__]+)__/g, '<strong>$1$2</strong>');
                    line = line.replace(/\*([^\*]+)\*|_([^_]+)_/g, '<em>$1$2</em>');

                    // Inline code
                    line = line.replace(/`([^`]+)`/g, '<code>$1</code>');
                    
                    // Unordered lists
                    if (/^\s*[\-\*]\s/.test(line)) {
                        if (inList !== 'ul') {
                            processedHtml += (inList ? `</${inList}>` : '') + '<ul>';
                            inList = 'ul';
                        }
                        processedHtml += `<li>${line.replace(/^\s*[\-\*]\s/, '')}</li>`;
                    } 
                    // Ordered lists
                    else if (/^\s*\d\.\s/.test(line)) {
                        if (inList !== 'ol') {
                            processedHtml += (inList ? `</${inList}>` : '') + '<ol>';
                            inList = 'ol';
                        }
                        processedHtml += `<li>${line.replace(/^\s*\d\.\s/, '')}</li>`;
                    } 
                    // Paragraphs
                    else {
                        if (inList) {
                            processedHtml += `</${inList}>`;
                            inList = null;
                        }
                        if (line.trim().length > 0) {
                             processedHtml += `<p>${line}</p>`;
                        }
                    }
                }
                if (inList) processedHtml += `</${inList}>`;

                return processedHtml;
            }


            #handleCopyClick(button) {
                const pre = button.closest('pre');
                const code = pre.querySelector('code');
                navigator.clipboard.writeText(code.innerText).then(() => {
                    button.textContent = 'Copied!';
                    button.classList.add('copied');
                    setTimeout(() => {
                        button.textContent = 'Copy';
                        button.classList.remove('copied');
                    }, 2000);
                });
            }

            async #requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        this.#wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Screen Wake Lock is active.');
                        this.#wakeLock.addEventListener('release', () => {
                            console.log('Screen Wake Lock was released by the system.');
                            this.#wakeLock = null;
                        });
                    } catch (err) {
                        this.#wakeLock = null;
                        console.error(`Failed to acquire screen wake lock: ${err.name}, ${err.message}`);
                    }
                } else {
                    console.warn('Screen Wake Lock API not supported in this browser.');
                }
            }

            async #releaseWakeLock() {
                if (this.#wakeLock !== null) {
                    try {
                        await this.#wakeLock.release();
                        this.#wakeLock = null;
                        console.log('Screen Wake Lock released programmatically.');
                    } catch (err) {
                        console.error(`Failed to release screen wake lock: ${err.name}, ${err.message}`);
                        this.#wakeLock = null;
                    }
                }
            }

            async #handleVisibilityChange() {
                if (document.visibilityState === 'visible' && this.#isStreaming && !this.#wakeLock) {
                    console.log('Page became visible during streaming, re-acquiring wake lock.');
                    await this.#requestWakeLock();
                }
            }
        }
    </script>
</body>
</html>